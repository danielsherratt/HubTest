<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CESW Hub – Reset Password</title>
  <link rel="icon" href="assets/favicon.ico" type="image/x-icon"/>
  <meta name="color-scheme" content="light only" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
  <style>
    :root { --brand:#00625f; --brand-700:#00514e; --bg:#f6f7f8; --text:#1f2d2e; --muted:#6b7c80; --border:#d0d6d9; --error:#b00020; --ok:#0a7a51; --radius:10px; --shadow:0 10px 25px rgba(0,0,0,.08); }
    *{ box-sizing:border-box; } html,body{ height:100%; }
    body{ margin:0; font-family:"Noto Sans",system-ui; color:var(--text); background:var(--bg); display:flex; flex-direction:column; min-height:100vh; }
    .banner{ width:100%; height:170px; background:url('assets/banner.jpg') center/cover no-repeat; }
    .wrap{ flex:1; display:grid; place-items:start center; padding:2rem 1rem 3rem; }
    .card{ width:100%; max-width:380px; background:#fff; border-radius:var(--radius); box-shadow:var(--shadow); padding:1.25rem 1.25rem 1.5rem; animation:floatIn .25s ease-out; }
    @keyframes floatIn{ from{ transform:translateY(8px); opacity:0;} to{ transform:translateY(0); opacity:1;} }
    h1{ font-size:1.25rem; margin:0 0 .25rem; color:var(--brand); text-align:center; font-weight:700;}
    .sub{ text-align:center; color:var(--muted); font-size:.95rem; margin-bottom:1rem; }
    form > * + *{ margin-top:.9rem; }
    .field{ display:grid; grid-template-columns:1fr auto; align-items:center; gap:.5rem; border:1px solid var(--border); border-radius:8px; padding:.2rem .5rem .2rem .6rem; background:#fff; }
    .field input{ border:0; outline:0; padding:.7rem .2rem; font-size:1rem; width:100%; background:transparent; }
    .icon-btn{ border:0; background:transparent; cursor:pointer; padding:.4rem .5rem; border-radius:6px; }
    .icon-btn:focus-visible{ outline:2px solid var(--brand); outline-offset:2px; }
    .btn{ width:100%; border:0; border-radius:8px; padding:.8rem 1rem; font-size:1rem; font-weight:600; cursor:pointer; background:var(--brand); color:#fff; }
    .btn:hover{ background:var(--brand-700); } .btn[disabled]{ opacity:.6; cursor:not-allowed; }
    .msg{ text-align:center; min-height:1.25rem; font-size:.95rem; } .msg.error{ color:var(--error);} .msg.ok{ color:var(--ok);}
    .muted{ color:var(--muted); font-size:.9rem; text-align:center; margin-top:.25rem;}
    .links{ display:flex; justify-content:space-between; margin-top:.25rem; font-size:.9rem; }
    .links a{ color:var(--brand); text-decoration:none; font-weight:600; } .links a:hover{ text-decoration:underline; }
    .req{ font-size:.9rem; margin:.25rem 0 0; padding:0; list-style:none; }
    .req li{ display:flex; align-items:center; gap:.45rem; color:#666; }
    .req li.ok{ color:var(--ok); } .req li .icon{ width:1.1rem; text-align:center; }
    .match{ font-size:.9rem; margin-top:.25rem; color:#666; } .match.ok{ color:var(--ok); } .match.err{ color:var(--error); }
    footer{ color:var(--muted); text-align:center; font-size:.85rem; padding:1rem 0 1.25rem; }
  </style>
</head>
<body>
  <div class="banner" role="img" aria-label="CESW banner"></div>

  <main class="wrap">
    <section class="card" role="region" aria-labelledby="reset-title">
      <h1 id="reset-title">Reset your password</h1>
      <p class="sub">At least 8 characters, including 1 uppercase and 1 number</p>

      <form id="reset-form" novalidate>
        <!-- New password -->
        <div class="field">
          <input id="pwd1" type="password" placeholder="New password" required minlength="8"
                 autocomplete="new-password" aria-label="New password"
                 title="At least 8 characters, incl. one uppercase and one number" />
          <button class="icon-btn" type="button" id="togglePwd1" aria-label="Show password">
            <i id="pwdIcon1" class="fa-regular fa-eye"></i>
          </button>
        </div>

        <!-- Requirements checklist -->
        <ul class="req" id="reqList" aria-live="polite">
          <li id="reqLen"><span class="icon">○</span> At least 8 characters</li>
          <li id="reqUpper"><span class="icon">○</span> At least 1 uppercase letter</li>
          <li id="reqNum"><span class="icon">○</span> At least 1 number</li>
        </ul>

        <!-- Confirm password -->
        <div class="field">
          <input id="pwd2" type="password" placeholder="Confirm new password" required minlength="8"
                 autocomplete="new-password" aria-label="Confirm new password"
                 title="At least 8 characters, incl. one uppercase and one number" />
          <button class="icon-btn" type="button" id="togglePwd2" aria-label="Show password">
            <i id="pwdIcon2" class="fa-regular fa-eye"></i>
          </button>
        </div>
        <div id="matchMsg" class="match" aria-live="polite"></div>

        <button class="btn" id="submitBtn" type="submit" disabled>Set Password</button>
        <div id="msg" class="msg" role="status" aria-live="polite"></div>

        <div class="links">
          <a href="index.html"><i class="fa-solid fa-arrow-left-long"></i> Back to sign in</a>
          <span id="tokenStatus" class="muted"></span>
        </div>
      </form>
    </section>
  </main>

  <footer>&copy; <span id="year"></span> CESW Hub</footer>

  <script>
    const qs = (id) => document.getElementById(id);
    const params = new URLSearchParams(location.search);
    const token = params.get('token') || '';

    const form = qs('reset-form');
    const msg = qs('msg');
    const btn = qs('submitBtn');
    const tokenStatus = qs('tokenStatus');
    const pwd1 = qs('pwd1'), pwd2 = qs('pwd2');
    const togglePwd1 = qs('togglePwd1'), togglePwd2 = qs('togglePwd2');
    const pwdIcon1 = qs('pwdIcon1'), pwdIcon2 = qs('pwdIcon2');
    const reqLen = qs('reqLen'), reqUpper = qs('reqUpper'), reqNum = qs('reqNum'), matchMsg = qs('matchMsg');

    document.getElementById('year').textContent = new Date().getFullYear();

    // token hint (actual validity checked server-side)
    if (!token) { tokenStatus.textContent = 'Missing or invalid link.'; tokenStatus.style.color = '#b00020'; btn.disabled = true; }
    else tokenStatus.textContent = 'Link present (expires after 3 hours).';

    function setMsg(text, ok=false){ msg.textContent = text || ''; msg.className = 'msg ' + (ok ? 'ok' : (text ? 'error' : '')); }
    function toggleField(field, icon, btnEl){
      const isPwd = field.type === 'password';
      field.type = isPwd ? 'text' : 'password';
      icon.className = isPwd ? 'fa-regular fa-eye-slash' : 'fa-regular fa-eye';
      btnEl.setAttribute('aria-label', isPwd ? 'Hide password' : 'Show password');
    }
    function policy(p){
      return {
        len: !!p && p.length >= 8,
        upper: /[A-Z]/.test(p),
        num: /\d/.test(p)
      };
    }
    function renderPolicy(p){
      const ok = (el, on) => {
        el.classList.toggle('ok', on);
        el.querySelector('.icon').textContent = on ? '✓' : '○';
      };
      const st = policy(p);
      ok(reqLen, st.len); ok(reqUpper, st.upper); ok(reqNum, st.num);
      return st.len && st.upper && st.num;
    }
    function renderMatch(p1, p2){
      if (!p2) { matchMsg.textContent = ''; matchMsg.className = 'match'; return false; }
      const same = p1 === p2;
      matchMsg.textContent = same ? 'Passwords match.' : 'Passwords do not match.';
      matchMsg.className = 'match ' + (same ? 'ok' : 'err');
      return same;
    }
    function evaluate(){
      const okPolicy = renderPolicy(pwd1.value);
      const okMatch  = renderMatch(pwd1.value, pwd2.value);
      btn.disabled = !(okPolicy && okMatch && !!token);
    }

    togglePwd1.addEventListener('click', () => toggleField(pwd1, pwdIcon1, togglePwd1));
    togglePwd2.addEventListener('click', () => toggleField(pwd2, pwdIcon2, togglePwd2));
    pwd1.addEventListener('input', evaluate);
    pwd2.addEventListener('input', evaluate);

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      setMsg('');
      evaluate();
      if (btn.disabled) return;

      const newPass = pwd1.value;
      btn.disabled = true; btn.textContent = 'Setting…';
      try {
        const r = await fetch('/api/auth/reset', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ token, password: newPass })
        });
        const data = await r.json().catch(()=> ({}));
        if (!r.ok) {
          setMsg(data?.error || 'Reset failed.');
        } else {
          // Auto-login using returned email (server change below returns { ok:true, email })
          if (data?.email) {
            const login = await fetch('/api/auth/login', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              credentials:'include',
              body: JSON.stringify({ email: data.email, password: newPass })
            });
            if (login.ok) {
              setMsg('Password updated! Logging you in…', true);
              location.href = '/feed.html';
              return;
            }
          }
          // Fallback if auto-login not available
          setMsg('Password updated! Please sign in.', true);
          setTimeout(() => location.href = '/index.html', 1100);
        }
      } catch {
        setMsg('Network error. Please try again.');
      } finally {
        btn.disabled = false; btn.textContent = 'Set Password';
      }
    });
  </script>
</body>
</html>
