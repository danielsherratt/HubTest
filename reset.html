<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CESW Hub – Reset Password</title>
  <link rel="icon" href="assets/favicon.ico" type="image/x-icon"/>
  <meta name="color-scheme" content="light only" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/auth.css">
</head>
<body>
  <div class="banner" role="img" aria-label="CESW banner"></div>

  <main class="wrap">
    <section class="card" role="region" aria-labelledby="reset-title">
      <h1 id="reset-title"><i class="fa-solid fa-people-group"></i> CESW Hub - Reset Password</h1>
      <p class="sub">Choose a strong password you haven’t used elsewhere.</p>

      <form id="reset-form" novalidate>
        <div class="field">
          <input id="pwd1" type="password" placeholder="New password" required minlength="8"
                 autocomplete="new-password" aria-label="New password"
                 title="At least 8 characters, incl. one uppercase and one number" />
          <button class="icon-btn" type="button" id="togglePwd1" aria-label="Show password">
            <i id="pwdIcon1" class="fa-regular fa-eye"></i>
          </button>
        </div>

        <!-- Requirements checklist -->
        <ul class="req" id="reqList" aria-live="polite">
          <li id="reqLen"><span class="icon">○</span> At least 8 characters</li>
          <li id="reqUpper"><span class="icon">○</span> At least 1 uppercase letter</li>
          <li id="reqNum"><span class="icon">○</span> At least 1 number</li>
        </ul>

        <div class="field">
          <input id="pwd2" type="password" placeholder="Confirm new password" required minlength="8"
                 autocomplete="new-password" aria-label="Confirm new password"
                 title="At least 8 characters, incl. one uppercase and one number" />
          <button class="icon-btn" type="button" id="togglePwd2" aria-label="Show password">
            <i id="pwdIcon2" class="fa-regular fa-eye"></i>
          </button>
        </div>
        <div id="matchMsg" class="match" aria-live="polite"></div>

        <button class="btn" id="submitBtn" type="submit" disabled>Set Password</button>
        <div id="msg" class="msg" role="status" aria-live="polite"></div>
      </form>
    </section>
  </main>

  <footer>&copy; <span id="year"></span> CESW Hub</footer>

  <script>
    // (same logic you had, kept intact)
    document.addEventListener('DOMContentLoaded', () => {
      const $ = (id) => document.getElementById(id) || null;
      const safeText = (id, text) => { const el = $(id); if (el) el.textContent = text; };
      const setClass = (el, cls, on) => { if (el) el.classList.toggle(cls, !!on); };

      const params = new URLSearchParams(location.search);
      const token = params.get('token') || '';

      const form = $('reset-form');
      const msg = $('msg');
      const btn = $('submitBtn');
      const pwd1 = $('pwd1'), pwd2 = $('pwd2');
      const togglePwd1 = $('togglePwd1'), togglePwd2 = $('togglePwd2');
      const pwdIcon1 = $('pwdIcon1'), pwdIcon2 = $('pwdIcon2');
      const reqLen = $('reqLen'), reqUpper = $('reqUpper'), reqNum = $('reqNum'), matchMsg = $('matchMsg');

      safeText('year', new Date().getFullYear());
      if (btn && !token) btn.disabled = true;

      function setMsg(text, ok=false){
        if (!msg) return;
        msg.textContent = text || '';
        msg.className = 'msg ' + (ok ? 'ok' : (text ? 'error' : ''));
      }
      function toggleField(field, icon, btnEl){
        if (!field || !icon || !btnEl) return;
        const isPwd = field.type === 'password';
        field.type = isPwd ? 'text' : 'password';
        icon.className = isPwd ? 'fa-regular fa-eye-slash' : 'fa-regular fa-eye';
        btnEl.setAttribute('aria-label', isPwd ? 'Hide password' : 'Show password');
      }
      function policy(p){
        return { len: !!p && p.length >= 8, upper: /[A-Z]/.test(p), num: /\d/.test(p) };
      }
      function renderPolicy(p){
        const st = policy(p);
        if (reqLen) { setClass(reqLen, 'ok', st.len); const ic = reqLen.querySelector?.('.icon'); if (ic) ic.textContent = st.len ? '✓' : '○'; }
        if (reqUpper){ setClass(reqUpper, 'ok', st.upper); const ic = reqUpper.querySelector?.('.icon'); if (ic) ic.textContent = st.upper ? '✓' : '○'; }
        if (reqNum){ setClass(reqNum, 'ok', st.num); const ic = reqNum.querySelector?.('.icon'); if (ic) ic.textContent = st.num ? '✓' : '○'; }
        return st.len && st.upper && st.num;
      }
      function renderMatch(p1, p2){
        if (!matchMsg) return p1 === p2 && !!p2;
        if (!p2) { matchMsg.textContent = ''; matchMsg.className = 'match'; return false; }
        const same = p1 === p2;
        matchMsg.textContent = same ? 'Passwords match.' : 'Passwords do not match.';
        matchMsg.className = 'match ' + (same ? 'ok' : 'err');
        return same;
      }
      function evaluate(){
        const okPolicy = renderPolicy(pwd1?.value || '');
        const okMatch  = renderMatch(pwd1?.value || '', pwd2?.value || '');
        if (btn) btn.disabled = !(okPolicy && okMatch && !!token);
      }

      if (togglePwd1 && pwd1 && pwdIcon1) togglePwd1.addEventListener('click', () => toggleField(pwd1, pwdIcon1, togglePwd1));
      if (togglePwd2 && pwd2 && pwdIcon2) togglePwd2.addEventListener('click', () => toggleField(pwd2, pwdIcon2, togglePwd2));
      if (pwd1) pwd1.addEventListener('input', evaluate);
      if (pwd2) pwd2.addEventListener('input', evaluate);

      evaluate();

      if (form) form.addEventListener('submit', async (e) => {
        e.preventDefault();
        setMsg('');
        evaluate();
        if (btn && btn.disabled) return;

        const newPass = pwd1?.value || '';
        if (!token) { setMsg('Invalid or missing link.'); return; }

        if (btn) { btn.disabled = true; btn.textContent = 'Setting…'; }
        try {
          const r = await fetch('/api/auth/reset', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ token, password: newPass })
          });

          let data = null;
          try { data = await r.json(); } catch {}

          if (!r.ok) {
            setMsg((data && data.error) || 'Reset failed.');
          } else {
            const email = data && data.email;
            if (email) {
              const login = await fetch('/api/auth/login', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                credentials:'include',
                body: JSON.stringify({ email, password: newPass })
              });
              if (login.ok) {
                setMsg('Password updated! Logging you in…', true);
                location.href = '/feed.html';
                return;
              }
            }
            setMsg('Password updated! Please sign in.', true);
            setTimeout(() => location.href = '/index.html', 1100);
          }
        } catch {
          setMsg('Network error. Please try again.');
        } finally {
          if (btn) { btn.disabled = false; btn.textContent = 'Set Password'; }
        }
      });
    });
  </script>
</body>
</html>
