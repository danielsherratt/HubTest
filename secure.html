<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CESW Hub - Admin</title>
  <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/cesw.css">
  <style>body{display:none}</style>

  <script>
    // --- Auth + Nav ---
    async function signOut(){ try{await fetch('/api/auth/logout',{method:'POST',credentials:'include'})}finally{location.href='/index.html'} }
    (async()=>{
      try{
        const r=await fetch('/api/auth/me',{credentials:'include'}); if(!r.ok) throw 0;
        const me=await r.json(); if(me.role!=='admin') throw 0;
        document.body.style.display='block';

        // Right-aligned nav actions
        const right=document.querySelector('.nav-right');
        const admin=document.createElement('a');
        admin.className='nav-item'; admin.href='secure.html';
        admin.innerHTML='<i class="fa-solid fa-gear"></i> Admin';
        right.appendChild(admin);
        const out=document.createElement('a');
        out.className='nav-item'; out.href='#';
        out.innerHTML='<i class="fa-solid fa-right-from-bracket"></i> Sign out';
        out.onclick=e=>{e.preventDefault();signOut()};
        right.appendChild(out);
      }catch{ location.href='/index.html'; }
    })();
  </script>
</head>
<body>
  <!-- NAV -->
  <div class="navbar">
    <div class="nav-inner">
      <div class="nav-left"></div>
      <div class="nav-center">
        <div class="nav-links">
          <a class="nav-item" href="feed.html"><i class="fa-solid fa-list-ul"></i> Feed</a>
          <a class="nav-item" href="resources.html"><i class="fa-solid fa-file"></i> Resources</a>
          <a class="nav-item" href="https://calendar.online/87060cd6717c9a3d9e8e" target="_blank" rel="noopener"><i class="fa-solid fa-calendar"></i> Calendar</a>
        </div>
      </div>
      <div class="nav-right"></div>
    </div>
  </div>

  <!-- Banner -->
  <div class="banner" role="img" aria-label="CESW banner"></div>

  <main class="admin-wrap">
    <h1 class="title"><i class="fa-solid fa-gear"></i> CESW Hub – Admin</h1>

    <!-- Per your earlier spec: distinct calendar button under heading -->
    <div class="center-row" style="margin-bottom:1rem;">
      <a class="btn btn-accent" href="https://calendar.online/852ff24234751e548d10" target="_blank" rel="noopener">
        <i class="fa-solid fa-calendar"></i> Calendar
      </a>
    </div>

    <!-- ========== Users ========== -->
    <section class="admin-section">
      <h2 class="subtitle">User Management</h2>

      <!-- Create user -->
      <form id="um-create" class="grid gap" autocomplete="off" style="max-width:900px;margin:0 auto 1rem;">
        <div class="grid2">
          <input type="text" name="first_name" placeholder="First name" required>
          <input type="text" name="last_name" placeholder="Last name" required>
        </div>
        <div class="grid2">
          <input type="email" name="email" placeholder="Email address" required autocomplete="off">
          <select name="role" required>
            <option value="" disabled selected>Role</option>
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="center-row">
          <button class="btn" type="submit"><i class="fa-solid fa-user-plus"></i> Create User</button>
        </div>
        <p class="muted center">A temporary password will be set server-side (or a reset email, depending on your backend).</p>
      </form>

      <!-- Search + sort -->
      <div class="grid2" style="max-width:900px;margin:0 auto 0.5rem;">
        <input type="text" id="um-search" placeholder="Search users… (name or email)">
        <select id="um-sort">
          <option value="last_sign_in|desc" selected>Last sign-in (newest)</option>
          <option value="created_at|desc">Created (newest)</option>
          <option value="email|asc">Email (A–Z)</option>
          <option value="first_name|asc">First name (A–Z)</option>
          <option value="last_name|asc">Last name (A–Z)</option>
          <option value="role|asc">Role (A–Z)</option>
        </select>
      </div>

      <!-- Table -->
      <div class="table-wrap" style="max-width:900px;margin:0 auto;">
        <table class="admin-table" id="um-table">
          <thead>
            <tr>
              <th>First</th>
              <th>Last</th>
              <th>Email</th>
              <th>Role</th>
              <th>Last sign-in</th>
              <th>IP</th>
              <th style="width:120px;">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <p id="um-empty" class="muted center" style="display:none;">No users match your search.</p>
      </div>
      <p class="muted center">Showing the 10 most recent users based on the selected sort.</p>
    </section>

    <!-- (Other admin sections like Resources / Feed can remain below unchanged) -->
  </main>

  <script>
    // ====== Users UI logic ======
    let umUsers = [];
    let umSortKey = 'last_sign_in';
    let umSortAsc = false;

    function nzDateTime(s){
      if(!s) return '';
      try{
        return new Date(s).toLocaleString('en-NZ',{ timeZone:'Pacific/Auckland' });
      }catch{ return s; }
    }

    function doSort(arr){
      const key = umSortKey;
      const asc = umSortAsc;
      const norm = (v) => (v ?? '');
      return [...arr].sort((a,b)=>{
        const A = norm(a[key]);
        const B = norm(b[key]);
        if (key.endsWith('_at') || key.includes('sign_in')) {
          // date-ish
          const dA = A ? new Date(A).getTime() : 0;
          const dB = B ? new Date(B).getTime() : 0;
          return asc ? (dA - dB) : (dB - dA);
        }
        if (A < B) return asc ? -1 : 1;
        if (A > B) return asc ? 1 : -1;
        return 0;
      });
    }

    function renderUsers(){
      const tbody = document.querySelector('#um-table tbody');
      const empty = document.getElementById('um-empty');
      const q = (document.getElementById('um-search').value || '').toLowerCase();

      const filtered = umUsers.filter(u => {
        const name = `${u.first_name||''} ${u.last_name||''}`.toLowerCase();
        return name.includes(q) || (u.email||'').toLowerCase().includes(q);
      });

      const sorted = doSort(filtered).slice(0, 10);

      tbody.innerHTML = '';
      if (sorted.length === 0) { empty.style.display='block'; return; } else { empty.style.display='none'; }

      for (const u of sorted){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${u.first_name || ''}</td>
          <td>${u.last_name || ''}</td>
          <td>${u.email || ''}</td>
          <td>${u.role || ''}</td>
          <td>${nzDateTime(u.last_sign_in)}</td>
          <td>${u.last_ip || ''}</td>
          <td>
            <button class="btn-ghost" data-del="${u.id}"><i class="fa-solid fa-trash"></i> Delete</button>
          </td>`;
        tbody.appendChild(tr);
      }

      // bind delete
      tbody.querySelectorAll('[data-del]').forEach(btn=>{
        btn.onclick = () => deleteUser(btn.getAttribute('data-del'));
      });
    }

    async function loadUsers(){
      const r = await fetch('/api/users', { credentials:'include' });
      if (!r.ok) { alert('Failed to load users'); return; }
      umUsers = await r.json();
      renderUsers();
    }

    async function deleteUser(id){
      if (!confirm('Delete this user? This will remove their sessions and comments.')) return;
      try{
        const res = await fetch(`/api/users/${id}`, { method:'DELETE', credentials:'include' });
        const data = await res.json().catch(()=>({}));
        if(!res.ok){ alert(data?.error || `Delete failed (HTTP ${res.status}).`); return; }
        await loadUsers();
      }catch{
        alert('Network error while deleting user.');
      }
    }

    // Create user
    document.getElementById('um-create').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = {
        first_name: fd.get('first_name')?.trim(),
        last_name:  fd.get('last_name')?.trim(),
        email:      fd.get('email')?.trim(),
        role:       fd.get('role')
      };
      if (!payload.first_name || !payload.last_name || !payload.email || !payload.role) {
        alert('Please complete all fields.'); return;
      }
      const res = await fetch('/api/users', {
        method:'POST', credentials:'include',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const j = await res.json().catch(()=>({}));
      if (!res.ok) { alert(j?.error || 'Create failed'); return; }
      e.target.reset();
      await loadUsers();
    });

    document.getElementById('um-search').addEventListener('input', renderUsers);
    document.getElementById('um-sort').addEventListener('change', (e)=>{
      const [k,dir] = e.target.value.split('|');
      umSortKey = k;
      umSortAsc = (dir==='asc');
      renderUsers();
    });

    document.addEventListener('DOMContentLoaded', loadUsers);
  </script>
</body>
</html>
