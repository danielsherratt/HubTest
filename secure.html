<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CESW Hub - Admin</title>

  <link rel="stylesheet" href="assets/admin.css">
  <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">

  <!-- Hide page until admin verified -->
  <style> body{ display:none; } </style>

  <!-- Admin gate: verify cookie + admin role via /api/auth/me -->
  <script>
  (async () => {
    try {
      const res = await fetch('/api/auth/me', { credentials: 'include' });
      if (!res.ok) throw new Error('Not authorized');
      const me = await res.json();
      if (!me || me.role !== 'admin') { window.location.href = '/index.html'; return; }
      document.body.style.display = 'block';
    } catch {
      window.location.href = '/index.html';
    }
  })();
  </script>
</head>
<body>
  <div class="banner"></div>

  <main style="max-width: 1000px; margin: auto;">
    <h1 class="title"><i class="fa-solid fa-gear"></i> CESW Hub - Admin</h1>

    <a class="calendarbutton" href="https://calendar.online/852ff24234751e548d10" target="_blank" rel="noopener">
      <i class="fa fa-calendar"></i> Calendar
    </a>

    <!-- ───────────────────────────── Upload Resource ───────────────────────────── -->
    <h2 class="title"><i class="fa-solid fa-plus"></i> Add Resource</h2>
    <form id="upload-form" class="upload-section" enctype="multipart/form-data">
      <!-- Either File or URL -->
      <input type="file" id="resource-file" />
      <input type="url" id="resource-url" placeholder="Or paste a link instead"><br>

      <!-- Type dropdown -->
      <select id="resource-type" required>
        <option value="">Select resource type</option>
        <option value="file">File</option>
        <option value="website">Website</option>
        <option value="video">Video</option>
      </select><br>

      <select id="resource-category" required>
        <option value="" disabled selected>Select category</option>
        <option value="general">General</option>
        <option value="resources">Resources</option>
        <option value="onlineresources">Online Resources</option>
        <option value="faq">FAQ</option>
      </select><br>

      <input type="text" id="resource-title" placeholder="Resource title" required /><br>

      <!-- Pinned checkbox -->
      <label class="star-checkbox">
        <input type="checkbox" id="resource-pinned" />
        <i class="fa-regular fa-star unchecked"></i>
        <i class="fa-solid fa-star checked"></i>
        Pin this resource
      </label><br>

      <button type="submit" id="new-upload-button">Add Resource</button>
    </form>

    <!-- ───────────────────────────── Manage Resources ───────────────────────────── -->
    <h2 class="title"><i class="fa-solid fa-list-ul"></i> Manage Resources</h2>
    <a href="resources.html" target="_blank" rel="noopener" alt="View Resources"><h3 class="title"><i class="fa-solid fa-eye"></i></h3></a>
    <input type="text" id="search-resources" class="search-bar" placeholder="Search resources...">
    <table id="resources-table">
      <thead>
        <tr>
          <th class="sortable" data-key="title">Title</th>
          <th class="sortable" data-key="created_date">Date</th>
          <th class="sortable" data-key="resource-category">Category</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p id="resources-empty" style="display:none;">Mmm, no resource found <i class="fa-solid fa-face-sad-tear"></i>, Please change your search</p>
    <i>Latest 10 are shown, search for the exact one you want</i>
    <div style="margin-bottom:1em;"></div>

    <!-- ───────────────────────────── Add Post ───────────────────────────── -->
    <h2 class="title"><i class="fa-solid fa-plus"></i> Add to Feed</h2>
    <form id="new-post">
      <input name="title" id="new-post-input" placeholder="Title" required />
      <select name="category" id="new-post-select" required>
        <option value="" disabled selected>Select category</option>
        <option value="general">General</option>
        <option value="resources">Resources</option>
        <option value="onlineresources">Online Resources</option>
        <option value="faq">FAQ</option>
      </select>
      <label class="star-checkbox">
        <input type="checkbox" name="pinned" />
        <i class="fa-regular fa-star unchecked"></i>
        <i class="fa-solid fa-star checked"></i>
        Pin this post
      </label>
      <div id="editor"></div>
      <button type="submit" id="new-post-button">Create Post</button>
    </form>

    <!-- ───────────────────────────── Manage Posts ───────────────────────────── -->
    <h2 class="title"><i class="fa-solid fa-list-ul"></i> Manage Feed</h2>
    <a href="feed.html" target="_blank" rel="noopener" alt="View Feed"><h3 class="title"><i class="fa-solid fa-eye"></i></h3></a>
    <input type="text" id="search-posts" class="search-bar" placeholder="Search posts...">
    <table id="posts-table">
      <thead>
        <tr>
          <th class="sortable" data-key="title">Title</th>
          <th class="sortable" data-key="created_at">Date</th>
          <th class="sortable" data-key="category">Category</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p id="posts-empty" style="display:none;">Mmm, no post found <i class="fa-solid fa-face-sad-tear"></i>, Please change your search</p>

    <i>Latest 10 are shown, search for the exact one you want</i>
    <a href="mailto:ITSupport@kotakureo.school.nz" id="one" class="link-nochange">
      <i class="fa-solid fa-life-ring"></i> Help
    </a>

    <!-- ───────────────────────────── User Management (searchable/sortable, top 10, alerts + RESET PASSWORD) ───────────────────────────── -->
    <h2 class="title"><i class="fa-solid fa-users-gear"></i> User Management</h2>

    <!-- Search box -->
    <input id="um-search" type="search" placeholder="Search users by email…" class="search-bar">

    <!-- Create user -->
    <section class="upload-section" style="padding:1rem;border:1px solid #e8ecee;border-radius:10px;margin-bottom:1rem;">
      <form id="um-create-form" autocomplete="off">
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:.5rem;align-items:end;">
          <div>
            <input id="um-email" type="email" class="search-bar" placeholder="Email" required />
          </div>
          <div>
            <input id="um-password" type="password" class="search-bar" placeholder="Password" required />
          </div>
          <div>
            <label for="um-role">Role</label>
            <select id="um-role">
              <option value="user">user</option>
              <option value="admin">admin</option>
            </select>
          </div>
          <div>
            <button type="submit" class="pinresource-btn"><i class="fa-solid fa-user-plus"></i> Create</button>
          </div>
        </div>
        <div id="um-create-msg" style="margin-top:.5rem;"></div>
      </form>
    </section>

    <!-- Users table -->
    <table id="um-table">
      <thead>
        <tr>
          <th class="um-sort" data-sort="email">Email <i class="fa-solid fa-sort"></i></th>
          <th class="um-sort" data-sort="role">Role <i class="fa-solid fa-sort"></i></th>
          <th class="um-sort" data-sort="last_sign_in">Last sign in <i class="fa-solid fa-sort"></i></th>
          <th class="um-sort" data-sort="created_at">Created <i class="fa-solid fa-sort"></i></th>
          <th>IP / Alerts</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="um-rows">
        <tr><td colspan="6">Loading…</td></tr>
      </tbody>
    </table>
  </main>

  <!-- EventTarget guard -->
  <script>
    (function() {
      const originalAddEventListener = EventTarget.prototype.addEventListener;
      EventTarget.prototype.addEventListener = function(type, listener, options) {
        if (type === 'DOMNodeInserted' || type === 'DOMNodeRemoved') return;
        return originalAddEventListener.call(this, type, listener, options);
      };
    })();
  </script>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';</script>

  <!-- Quill -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

  <script>

    function applyNZ(selector = '.nz-dt') {
  document.querySelectorAll(selector).forEach(el => {
    const raw = el.getAttribute('data-ts') || el.textContent;
    el.textContent = nzDateTime(raw);
  });
}
    
    // ───────────────────── Quill editor ─────────────────────
    const quill = new Quill('#editor', {
      theme: 'snow',
      modules: {
        toolbar: [
          ['bold', 'italic'],
          [{ header: [1, 2, 3, false] }],
          [{ list: 'ordered' }, { list: 'bullet' }],
          ['image']
        ]
      }
    });

    // Set resource type to "file" when file chosen
    document.getElementById('resource-file').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) document.getElementById('resource-type').value = 'file';
    });

    let posts = [];
    let resources = [];
    let postSort = { key: 'created_at', asc: false };
    let resourceSort = { key: 'created_date', asc: false };

    // ───────────────────── Fetch posts/resources ─────────────────────
    async function fetchPosts() {
      const res = await fetch('/api/posts?admin=true', { credentials: 'include' });
      if (res.status === 401) return location.href = '/index.html';
      posts = await res.json();
      renderPosts();
    }

    async function fetchResources() {
      const res = await fetch('/api/resourcespull', { credentials: 'include' });
      if (res.status === 401) return location.href = '/index.html';
      resources = await res.json();
      renderResources();
    }

    function renderPosts() {
      const tbody = document.querySelector('#posts-table tbody');
      const emptyMsg = document.getElementById('posts-empty');
      const search = document.getElementById('search-posts').value.toLowerCase();

      const filtered = posts
        .filter(p => p.title.toLowerCase().includes(search))
        .sort(sortBy(postSort.key, postSort.asc))
        .slice(0, 10);

      tbody.innerHTML = '';

      if (filtered.length === 0) {
        emptyMsg.style.display = 'block';
        return;
      } else {
        emptyMsg.style.display = 'none';
      }

      for (const p of filtered) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${p.title}</td>
          <td>${new Date(p.created_at).toLocaleDateString()}</td>
          <td>${p.category}</td>
          <td>
            <button class="pin-btn" onclick="togglePinPost(${p.id}, '${p.category}', ${p.pinned})">
              <i class="${p.pinned ? 'fa-solid fa-star' : 'fa-regular fa-star'}"></i> ${p.pinned ? 'Unpin' : 'Pin'}
            </button>
            <button class="delete-btn" onclick="deletePost(${p.id})"><i class="fa fa-trash"></i> Delete</button>
          </td>`;
        tbody.appendChild(row);
      }
    }

    function renderResources() {
      const tbody = document.querySelector('#resources-table tbody');
      const emptyMsg = document.getElementById('resources-empty');
      const search = document.getElementById('search-resources').value.toLowerCase();

      const filtered = resources
        .filter(r => r.title.toLowerCase().includes(search))
        .sort(sortBy(resourceSort.key, resourceSort.asc))
        .slice(0, 10);

      tbody.innerHTML = '';

      if (filtered.length === 0) {
        emptyMsg.style.display = 'block';
        return;
      } else {
        emptyMsg.style.display = 'none';
      }

      for (const r of filtered) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><a href="${r.url}" class="link-nochange" target="_blank" rel="noopener">${r.title}</a></td>
          <td>${new Date(r.created_date).toLocaleDateString()}</td>
          <td>${r.category}</td>
          <td>
            <button class="pinresource-btn" onclick="togglePinResource(${r.id}, ${r.pinned})">
              <i class="${r.pinned ? 'fa-solid fa-star' : 'fa-regular fa-star'}"></i> ${r.pinned ? 'Unpin' : 'Pin'}
            </button>
            <button class="deleteresource-btn" onclick="deleteResource(${r.id})"><i class="fa fa-trash"></i> Delete</button>
          </td>`;
        tbody.appendChild(row);
      }
    }

    function sortBy(key, asc) {
      return (a, b) => {
        const valA = a[key]?.toLowerCase?.() || a[key];
        const valB = b[key]?.toLowerCase?.() || b[key];
        if (valA < valB) return asc ? -1 : 1;
        if (valA > valB) return asc ? 1 : -1;
        return 0;
      };
    }

    // ───────────────────── Post actions ─────────────────────
    window.togglePinPost = async (id, category, pinned) => {
      const newCat = pinned ? category.replace(/^pinned\s*/i, '') : `pinned ${category}`;
      await fetch(`/api/posts/${id}`, {
        method: 'PUT',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ category: newCat, pinned: !pinned })
      });
      fetchPosts();
    };

    window.deletePost = async (id) => {
      if (confirm('Delete this post?')) {
        await fetch(`/api/posts/${id}`, { method: 'DELETE', credentials: 'include' });
        fetchPosts();
      }
    };

    // ───────────────────── Resource actions ─────────────────────
    window.togglePinResource = async (id, pinned) => {
      await fetch(`/api/resources/${id}`, {
        method: 'PUT',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pinned: !pinned })
      });
      fetchResources();
    };

    window.deleteResource = async (id) => {
      if (confirm('Delete this resource?')) {
        await fetch(`/api/resources/${id}`, { method: 'DELETE', credentials: 'include' });
        fetchResources();
      }
    };

    // ───────────────────── Create Post submit ─────────────────────
    document.getElementById('new-post').addEventListener('submit', async e => {
      e.preventDefault();
      const form = e.target;
      const title = form.title.value;
      const category = form.category.value;
      const pinned = form.pinned.checked;
      await fetch('/api/posts', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, category: pinned ? `pinned ${category}` : category, body: quill.root.innerHTML, pinned })
      });
      form.reset();
      quill.setContents([]);
      fetchPosts();
    });

    // ───────────────────── Upload Resource submit ─────────────────────
    document.getElementById('upload-form').addEventListener('submit', async e => {
      e.preventDefault();

      const file = document.getElementById('resource-file').files[0];
      const urlInput = document.getElementById('resource-url').value.trim();
      const title = document.getElementById('resource-title').value.trim();
      const pinned = document.getElementById('resource-pinned').checked;
      const type = document.getElementById('resource-type').value;
      const category = document.getElementById('resource-category').value.trim();

      if (!file && !urlInput) return alert("Please provide a file or a URL.");
      if (!title || !type) return alert("Title and type are required.");

      const formData = new FormData();
      formData.append('title', title);
      formData.append('pinned', pinned);
      formData.append('type', type);
      formData.append('category', category);

      if (file) {
        formData.append('file', file);
        if (file.type === "application/pdf") {
          // Generate thumbnail from PDF
          const pdfThumb = await generatePdfThumbnail(file);
          if (pdfThumb) formData.append('thumbnail', pdfThumb);
        }
      } else {
        formData.append('url', urlInput);
        // Generate thumbnail via Microlink
        const thumbnailUrl = `https://api.microlink.io/?url=${encodeURIComponent(urlInput)}&screenshot=true&meta=false`;
        try {
          const response = await fetch(thumbnailUrl);
          const data = await response.json();
          const imgUrl = data?.data?.screenshot?.url;
          if (imgUrl) {
            const imageBlob = await fetch(imgUrl).then(r => r.blob());
            const base64 = await blobToBase64(imageBlob);
            formData.append('thumbnail', base64);
          }
        } catch (err) {
          console.warn("Microlink thumbnail failed:", err);
        }
      }

      await fetch('/api/resources/upload', { method: 'POST', body: formData });
      location.reload();
    });

    async function generatePdfThumbnail(file) {
      try {
        const pdfData = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({ scale: 1 });
        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");
        canvas.width = viewport.width; canvas.height = viewport.height;
        await page.render({ canvasContext: context, viewport }).promise;
        return canvas.toDataURL("image/png");
      } catch (err) {
        console.error("PDF thumbnail generation failed:", err);
        return null;
      }
    }

    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    document.getElementById('search-posts').addEventListener('input', renderPosts);
    document.getElementById('search-resources').addEventListener('input', renderResources);

    document.querySelectorAll('#posts-table th.sortable').forEach(th =>
      th.addEventListener('click', () => {
        const key = th.dataset.key;
        postSort.asc = key === postSort.key ? !postSort.asc : true;
        postSort.key = key;
        renderPosts();
      })
    );

    document.querySelectorAll('#resources-table th.sortable').forEach(th =>
      th.addEventListener('click', () => {
        const key = th.dataset.key;
        resourceSort.asc = key === resourceSort.key ? !resourceSort.asc : true;
        resourceSort.key = key;
        renderResources();
      })
    );

    // ───────────────────── User Management logic (search + sort + top 10 + alerts + reset) ─────────────────────
    const umRows = document.getElementById('um-rows');
    const umForm = document.getElementById('um-create-form');
    const umMsg  = document.getElementById('um-create-msg');
    const umSearch = document.getElementById('um-search');
    const umSortHeaders = document.querySelectorAll('.um-sort');

    // default: top 10 by created_at DESC
    let umSortKey = 'created_at';
    let umSortAsc = false;

    function umSortIcon(th, active, asc) {
      const i = th.querySelector('i');
      if (!i) return;
      if (!active) { i.className = 'fa-solid fa-sort'; return; }
      i.className = asc ? 'fa-solid fa-sort-up' : 'fa-solid fa-sort-down';
    }

    function esc(s){
      return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    async function umLoadUsers(){
      const q = umSearch.value.trim();
      const params = new URLSearchParams({
        q,
        sort: umSortKey,
        dir: umSortAsc ? 'asc' : 'desc'
      });
      try{
        // Server enforces LIMIT 10 and computes distinct_ips_24h
        const r = await fetch('/api/users?' + params.toString(), { credentials:'include' });
        if(!r.ok){ umRows.innerHTML = '<tr><td colspan="6">Failed to load users.</td></tr>'; return; }
        let data = await r.json();
        if (!Array.isArray(data)) data = [];
        // Safety: cap at 10 if server not yet updated
        data = data.slice(0, 10);

        if(!data.length){ umRows.innerHTML = '<tr><td colspan="6">No users.</td></tr>'; return; }

        umRows.innerHTML = data.map(u => {
          const multiIp = Number(u.distinct_ips_24h || 0);
          const alert = (multiIp >= 3)
            ? `<span class="chip" title="Signed in from ${multiIp} IPs in last 24h" style="background:#fff3cd;color:#8a6d3b"><i class="fa-solid fa-triangle-exclamation"></i> multi-IP</span>`
            : '';
          return `
            <tr data-id="${u.id}">
              <td>${esc(u.email)}</td>
              <td><span class="chip">${esc(u.role)}</span></td>
  <td class="nz-dt" data-ts="${u.last_sign_in || ''}"></td>
  <td class="nz-dt" data-ts="${u.created_on || u.created_at || ''}"></td>
              <td>
                <div>${esc(u.last_sign_ip || '')}</div>
                ${alert}
              </td>
              <td style="display:flex; gap:.35rem; flex-wrap:wrap;">
                <button class="pinresource-btn" data-reset="${u.id}">
                  <i class="fa-solid fa-key"></i> Reset Password
                </button>
                <button class="deleteresource-btn" data-del="${u.id}">
                  <i class="fa-solid fa-user-xmark"></i> Delete
                </button>
              </td>
            </tr>
          `;
        }).join('');

      } catch (e) {
        umRows.innerHTML = '<tr><td colspan="6">Error loading users.</td></tr>';
      }

      // update sort icons
      umSortHeaders.forEach(th => {
        umSortIcon(th, th.dataset.sort === umSortKey, umSortAsc);
      });
    }

    // Handle row actions: reset password / delete
    umRows.addEventListener('click', async (e)=>{
      const resetBtn = e.target.closest('button[data-reset]');
      const delBtn   = e.target.closest('button[data-del]');

      if (resetBtn) {
        const id = resetBtn.dataset.reset;
        const row = resetBtn.closest('tr');
        const email = row?.children?.[0]?.textContent?.trim() || '';
        const p1 = prompt(`Set new password for ${email}:`);
        if (!p1) return;
        const p2 = prompt('Confirm new password:');
        if (p1 !== p2) { alert('Passwords do not match.'); return; }
        if (p1.length < 6) { alert('Password must be at least 6 characters.'); return; }
        try{
          const r = await fetch('/api/users/' + id, {
            method:'PUT',
            headers: { 'Content-Type':'application/json' },
            credentials:'include',
            body: JSON.stringify({ password: p1 })
          });
          if (r.ok) {
            alert('Password updated.');
          } else {
            const data = await r.json().catch(()=>({}));
            alert('Reset failed: ' + (data?.error || r.status));
          }
        }catch(err){
          alert('Network error while resetting password.');
        }
        return;
      }

      if (delBtn) {
        const id = delBtn.dataset.del;
        if(!confirm('Delete this user? This cannot be undone.')) return;
        try{
          const r = await fetch('/api/users/'+id, { method:'DELETE', credentials:'include' });
          if(r.status === 204){ umLoadUsers(); return; }
          const t = await r.text();
          alert('Delete failed: ' + t);
        }catch(err){ alert('Delete error'); }
        return;
      }
    });

    // Create user
    document.getElementById('um-create-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const umMsg  = document.getElementById('um-create-msg');
      umMsg.textContent = '';
      const email = document.getElementById('um-email').value.trim();
      const password = document.getElementById('um-password').value;
      const role = document.getElementById('um-role').value;
      try{
        const r = await fetch('/api/users', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({ email, password, role })
        });
        if(r.ok){
          umMsg.style.color = '#00625f';
          umMsg.textContent = 'User created.';
          e.target.reset();
          umLoadUsers();
        } else {
          let data={}; try{ data = await r.json(); }catch{}
          umMsg.style.color = '#b00020';
          umMsg.textContent = data?.error || 'Create failed.';
        }
      }catch(err){
        umMsg.style.color = '#b00020';
        umMsg.textContent = 'Network error.';
      }
    });

    // Search (debounced)
    let umT;
    document.getElementById('um-search').addEventListener('input', () => {
      clearTimeout(umT);
      umT = setTimeout(umLoadUsers, 200);
    });

    // Sort headers
    document.querySelectorAll('.um-sort').forEach(th => {
      th.style.cursor = 'pointer';
      th.addEventListener('click', () => {
        const key = th.dataset.sort;
        if (key === umSortKey) {
          umSortAsc = !umSortAsc;
        } else {
          umSortKey = key;
          umSortAsc = key === 'email' || key === 'role' ? true : false; // default asc for text cols
        }
        umLoadUsers();
      });
    });

    // Initial loads
    document.addEventListener('DOMContentLoaded', () => {
      fetchPosts();
      fetchResources();
      umLoadUsers();
    });
  </script>
</body>
</html>
