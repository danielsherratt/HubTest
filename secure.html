<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CESW Hub – Admin</title>
  <link rel="icon" href="assets/favicon.ico" type="image/x-icon" />
  <meta name="color-scheme" content="light only" />

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">

  <!-- Admin-only gate: hide document until verified as admin -->
  <style id="admin-hide">html{visibility:hidden}</style>
  <script>
    (async function() {
      try {
        const r = await fetch('/api/auth/me', { credentials: 'include' });
        if (!r.ok) { window.location.href = '/index.html'; return; }
        const me = await r.json();
        if (!me || me.role !== 'admin') { window.location.href = '/index.html'; return; }
        // Allowed: reveal page
        document.getElementById('admin-hide')?.remove();
        // Show who is signed in (optional)
        const who = document.getElementById('whoami'); if (who) who.textContent = me.email || 'admin';
      } catch {
        window.location.href = '/index.html';
      }
    })();
  </script>

  <style>
    :root {
      --brand: #00625f;
      --brand-700: #00514e;
      --bg: #f6f7f8;
      --text: #1f2d2e;
      --muted: #6b7c80;
      --border: #d0d6d9;
      --error: #b00020;
      --radius: 10px;
      --shadow: 0 10px 25px rgba(0,0,0,.08);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: "Noto Sans", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, sans-serif;
      color: var(--text);
      background: var(--bg);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    .banner {
      width: 100%;
      height: 170px;
      background: url('assets/banner.jpg') center/cover no-repeat;
    }
    header .bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: .75rem 1rem;
      background: #ffffffcc;
      backdrop-filter: saturate(1.2) blur(2px);
      border-bottom: 1px solid #e8ecee;
    }
    header .title {
      font-weight: 700;
      color: var(--brand);
      display: flex; align-items: center; gap: .5rem;
    }
    header .meta { color: var(--muted); font-size: .95rem; }
    header .actions {
      display: flex; gap: .5rem; align-items: center;
    }
    .btn {
      border: 0; border-radius: 8px; padding: .55rem .8rem;
      background: var(--brand); color: #fff; cursor: pointer;
      font-weight: 600;
    }
    .btn.secondary { background: #e9eef0; color: #113; }
    .btn.danger { background: #b00020; }
    .wrap { flex: 1; padding: 1.25rem; display: grid; gap: 1rem; }
    .panel {
      background: #fff; border-radius: var(--radius); box-shadow: var(--shadow);
      border: 1px solid #eef2f4;
    }
    .panel .hd { padding: .9rem 1rem; border-bottom: 1px solid #eef2f4; color: var(--brand); font-weight: 700; display:flex; align-items:center; justify-content:space-between;}
    .panel .bd { padding: 1rem; }

    /* User Management */
    .admin-grid{display:grid;grid-template-columns:1fr 2fr;gap:1rem}
    .admin-card{border:1px solid var(--border);border-radius:10px;padding:.9rem}
    .admin-card h3{margin:.25rem 0 .5rem;color:#334;font-size:1.05rem}
    .admin-card label{display:block;font-size:.9rem;margin:.4rem 0 .2rem}
    .admin-card input,.admin-card select{width:100%;padding:.6rem;border:1px solid var(--border);border-radius:8px}
    .admin-actions{margin-top:.75rem;display:flex;gap:.5rem}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid #eef2f4;padding:.55rem;text-align:left;font-size:.95rem;vertical-align:middle}
    .chip{display:inline-block;padding:.2rem .5rem;border-radius:999px;background:#eef6f6;color:#00625f;font-size:.85rem}
    .muted{color:var(--muted)}
    .right{ text-align:right; }
  </style>
</head>
<body>
  <div class="banner" role="img" aria-label="CESW banner"></div>

  <header>
    <div class="bar">
      <div class="title">
        <i class="fa-solid fa-shield-halved"></i> CESW Hub — Admin
        <span class="meta">(<span id="whoami">admin</span>)</span>
      </div>
      <div class="actions">
        <!-- If you add a /api/auth/logout endpoint later, hook a real sign out -->
        <a class="btn secondary" href="/feed.html"><i class="fa-solid fa-house"></i> Home</a>
      </div>
    </div>
  </header>

  <main class="wrap">

    <!-- ===== User Management ===== -->
    <section class="panel" aria-label="User Management">
      <div class="hd">
        <span>User Management</span>
      </div>
      <div class="bd">
        <div class="admin-grid">
          <div class="admin-card">
            <h3>Create user</h3>
            <form id="createUserForm" autocomplete="off">
              <label for="userEmail">Email</label>
              <input id="userEmail" name="email" type="email" required placeholder="user@example.com">
              <label for="userPassword">Password</label>
              <input id="userPassword" name="password" type="password" required placeholder="Set a password">
              <label for="userRole">Role</label>
              <select id="userRole" name="role">
                <option value="user">user</option>
                <option value="admin">admin</option>
              </select>
              <div class="admin-actions">
                <button class="btn" type="submit"><i class="fa-solid fa-user-plus"></i> Create</button>
                <button class="btn secondary" type="button" id="resetCreateForm">Reset</button>
              </div>
              <div id="createUserMsg" style="margin-top:.4rem;font-size:.95rem;"></div>
            </form>
          </div>

          <div class="admin-card">
            <h3>Existing users</h3>
            <table class="table">
              <thead>
                <tr><th>Email</th><th>Role</th><th>Last sign in</th><th>IP</th><th class="right"></th></tr>
              </thead>
              <tbody id="userRows">
                <tr><td colspan="5" class="muted">Loading…</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- You can add other admin panels below as more .panel blocks -->

  </main>

  <script>
    (function(){
      const rows = document.getElementById('userRows');
      const form = document.getElementById('createUserForm');
      const resetBtn = document.getElementById('resetCreateForm');
      const msg = document.getElementById('createUserMsg');

      function esc(s){
        return String(s ?? '').replace(/[&<>"']/g, function(m){
          return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
        });
      }

      async function loadUsers(){
        try{
          const r = await fetch('/api/users', { credentials: 'include' });
          if(!r.ok){ rows.innerHTML = '<tr><td colspan="5">Failed to load users.</td></tr>'; return; }
          const data = await r.json();
          if(!data.length){ rows.innerHTML = '<tr><td colspan="5" class="muted">No users.</td></tr>'; return; }
          rows.innerHTML = data.map(u => `
            <tr data-id="${u.id}">
              <td>${esc(u.email)}</td>
              <td><span class="chip">${esc(u.role)}</span></td>
              <td>${esc(u.last_sign_in || '')}</td>
              <td>${esc(u.last_sign_ip || '')}</td>
              <td class="right"><button class="btn secondary" style="color:#b00020" data-del="${u.id}"><i class="fa-solid fa-user-xmark"></i> Delete</button></td>
            </tr>
          `).join('');
        }catch(e){
          rows.innerHTML = '<tr><td colspan="5">Error loading users.</td></tr>';
        }
      }

      rows?.addEventListener('click', async (e)=>{
        const id = e.target?.dataset?.del || e.target?.closest('button')?.dataset?.del;
        if(!id) return;
        if(!confirm('Delete this user? This cannot be undone.')) return;
        try{
          const r = await fetch('/api/users/'+id, { method:'DELETE', credentials:'include' });
          if(r.status === 204){ loadUsers(); return; }
          const t = await r.text();
          alert('Delete failed: ' + t);
        }catch(err){ alert('Delete error'); }
      });

      form?.addEventListener('submit', async (e)=>{
        e.preventDefault();
        msg.textContent='';
        const payload = {
          email: form.email.value.trim(),
          password: form.password.value,
          role: form.role.value
        };
        try{
          const r = await fetch('/api/users', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            credentials:'include',
            body: JSON.stringify(payload)
          });
          if(r.ok){
            msg.style.color='#00625f';
            msg.textContent='User created.';
            form.reset();
            loadUsers();
          } else {
            let data={}; try{ data = await r.json(); }catch{}
            msg.style.color='#b00020';
            msg.textContent = data?.error || 'Create failed.';
          }
        }catch(err){
          msg.style.color='#b00020';
          msg.textContent='Network error.';
        }
      });

      resetBtn?.addEventListener('click', ()=> form.reset());

      loadUsers();
    })();
  </script>
</body>
</html>
