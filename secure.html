<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CESW Hub - Admin</title>

  <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="assets/app.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Quill for feed editor -->
  <link rel="stylesheet" href="https://cdn.quilljs.com/1.3.6/quill.snow.css">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

  <!-- PDF.js for resource thumbnails -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';</script>

  <style>body{display:none}</style>
  <script>
    async function signOut(){
      try { await fetch('/api/auth/logout', { method:'POST', credentials:'include' }); }
      finally { location.href='/index.html'; }
    }

    let ME=null;

    (async () => {
      try {
        const r = await fetch('/api/auth/me', { credentials:'include' });
        if (!r.ok) throw 0;
        ME = await r.json();
        if (ME.role !== 'admin') throw 0;

        document.body.style.display='block';

        // Right-side nav buttons (Admin + Sign out)
        const right = document.querySelector('.nav-right');
        if (!right.querySelector('a[href="secure.html"]')) {
          const a=document.createElement('a'); a.className='nav-item'; a.href='secure.html'; a.textContent='Admin';
          right.appendChild(a);
        }
        if (!document.getElementById('signOutBtn')) {
          const b=document.createElement('button'); b.id='signOutBtn'; b.className='nav-item'; b.textContent='Sign out'; b.onclick=signOut;
          right.appendChild(b);
        }
      } catch {
        location.href='/index.html';
      }
    })();
  </script>
</head>
<body>
  <!-- NAV -->
  <div class="navbar">
    <div class="nav-left"><span class="menu-icon">&#9776;</span></div>
    <div class="nav-center">
      <div class="nav-links">
        <a class="nav-item" href="feed.html">Feed</a>
        <a class="nav-item" href="resources.html">Resources</a>
        <a class="nav-item" href="https://calendar.online/87060cd6717c9a3d9e8e" target="_blank" rel="noopener">Calendar</a>
      </div>
    </div>
    <div class="nav-right"></div>
  </div>

  <div class="banner"></div>
  <main style="max-width: 1000px; margin: auto;">
    <h1 class="title"><i class="fa-solid fa-gear"></i> CESW Hub – Admin</h1>

    <!-- ---------------------- USERS ---------------------- -->
    <section>
      <h2 class="title"><i class="fa-solid fa-users"></i> Users</h2>

      <!-- Create User -->
      <form id="create-user-form" class="card" style="display:grid;gap:.6rem;margin-bottom:1rem;">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.6rem;">
          <input type="text" id="cu-first" placeholder="First name" required>
          <input type="text" id="cu-last"  placeholder="Last name" required>
        </div>
        <div style="display:grid;grid-template-columns:2fr 1fr;gap:.6rem;">
          <input type="email" id="cu-email" placeholder="Email" required autocomplete="email">
          <select id="cu-role" required>
            <option value="" disabled selected>Role</option>
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.6rem;">
          <input type="password" id="cu-pass" placeholder="Temporary password (leave blank to auto-generate)" autocomplete="new-password">
          <label class="agree" style="align-items:center">
            <input type="checkbox" id="cu-send-welcome" checked>
            <span>Send welcome email</span>
          </label>
        </div>
        <button type="submit" class="btn" id="cu-btn">Create user</button>
        <div id="cu-msg" class="muted"></div>
      </form>

      <!-- Search + table -->
      <div class="card">
        <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;margin-bottom:.6rem">
          <input id="user-search" class="search-bar" placeholder="Search users by name or email…">
          <span class="muted">Showing latest 10 by last sign-in</span>
        </div>

        <table id="users-table">
          <thead>
            <tr>
              <th class="sortable" data-key="name">Name</th>
              <th class="sortable" data-key="email">Email</th>
              <th class="sortable" data-key="role">Role</th>
              <th class="sortable" data-key="last_sign_in">Last sign-in (NZ)</th>
              <th>IP</th>
              <th>Alerts</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <p id="users-empty" class="muted" style="display:none;margin:.6rem 0 0;">No users match your search.</p>
      </div>
    </section>

    <div style="height:1.25rem"></div>

    <!-- ---------------------- RESOURCES ---------------------- -->
    <section>
      <h2 class="title"><i class="fa-solid fa-folder-plus"></i> Add Resource</h2>
      <form id="upload-form" class="card" enctype="multipart/form-data" style="display:grid;gap:.6rem;">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.6rem;">
          <input type="file" id="resource-file" />
          <input type="url" id="resource-url" placeholder="Or paste a link instead">
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:.6rem;">
          <select id="resource-type" required>
            <option value="" disabled selected>Select resource type</option>
            <option value="file">File</option>
            <option value="website">Website</option>
            <option value="video">Video</option>
          </select>
          <select id="resource-category" required>
            <option value="" disabled selected>Select category</option>
            <option value="general">General</option>
            <option value="resources">Resources</option>
            <option value="onlineresources">Online Resources</option>
            <option value="faq">FAQ</option>
          </select>
          <label class="agree" style="align-items:center">
            <input type="checkbox" id="resource-pinned">
            <span>Pin</span>
          </label>
        </div>

        <input type="text" id="resource-title" placeholder="Resource title" required />
        <button type="submit" class="btn" id="new-upload-button">Add Resource</button>
      </form>

      <h2 class="title"><i class="fa-solid fa-list-ul"></i> Manage Resources</h2>
      <div class="card">
        <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;margin-bottom:.6rem">
          <input type="text" id="search-resources" class="search-bar" placeholder="Search resources...">
          <a href="resources.html" target="_blank" class="nav-item"><i class="fa-solid fa-eye"></i> View</a>
        </div>

        <table id="resources-table">
          <thead>
            <tr>
              <th class="sortable" data-key="title">Title</th>
              <th class="sortable" data-key="created_date">Date</th>
              <th class="sortable" data-key="category">Category</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <p id="resources-empty" class="muted" style="display:none;margin:.6rem 0 0;">No resources found. Try a different search.</p>
        <div class="muted">Latest 10 are shown, search for the exact one you want.</div>
      </div>
    </section>

    <div style="height:1.25rem"></div>

    <!-- ---------------------- FEED ---------------------- -->
    <section>
      <h2 class="title"><i class="fa-solid fa-plus"></i> Add to Feed</h2>
      <form id="new-post" class="card" style="display:grid;gap:.6rem;">
        <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:.6rem;">
          <input name="title" id="new-post-input" placeholder="Title" required />
          <select name="category" id="new-post-select" required>
            <option value="" disabled selected>Select category</option>
            <option value="general">General</option>
            <option value="resources">Resources</option>
            <option value="onlineresources">Online Resources</option>
            <option value="faq">FAQ</option>
          </select>
          <label class="agree" style="align-items:center">
            <input type="checkbox" name="pinned" />
            <span>Pin</span>
          </label>
        </div>
        <div id="editor"></div>
        <button type="submit" class="btn" id="new-post-button">Create Post</button>
      </form>

      <h2 class="title"><i class="fa-solid fa-list-ul"></i> Manage Feed</h2>
      <div class="card">
        <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;margin-bottom:.6rem">
          <input type="text" id="search-posts" class="search-bar" placeholder="Search posts...">
          <a href="feed.html" target="_blank" class="nav-item"><i class="fa-solid fa-eye"></i> View</a>
        </div>

        <table id="posts-table">
          <thead>
            <tr>
              <th class="sortable" data-key="title">Title</th>
              <th class="sortable" data-key="created_at">Date</th>
              <th class="sortable" data-key="category">Category</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <p id="posts-empty" class="muted" style="display:none;margin:.6rem 0 0;">No posts found. Try a different search.</p>
        <div class="muted">Latest 10 are shown, search for the exact one you want.</div>
      </div>
    </section>

    <div style="height:1.25rem"></div>

    <a class="nav-item" href="https://calendar.online/852ff24234751e548d10" target="_blank" rel="noopener">
      <i class="fa fa-calendar"></i> Calendar
    </a>

    <a href="mailto:ITSupport@kotakureo.school.nz" class="nav-item">
      <i class="fa-solid fa-life-ring"></i> Help
    </a>
  </main>

  <script>
    /* ---------- Utils ---------- */
    function nzDateTime(value){
      const d = new Date(value);
      if (isNaN(d)) return '';
      return d.toLocaleString('en-NZ', {
        timeZone:'Pacific/Auckland',
        year:'numeric', month:'short', day:'2-digit',
        hour:'2-digit', minute:'2-digit'
      }).replace(',', '');
    }

    function sortBy(key, asc){
      return (a,b)=>{
        const A = (a[key] ?? '').toString().toLowerCase();
        const B = (b[key] ?? '').toString().toLowerCase();
        if (A < B) return asc ? -1:1;
        if (A > B) return asc ? 1:-1;
        return 0;
      };
    }

    (function blockMutationEvents(){
      const orig = EventTarget.prototype.addEventListener;
      EventTarget.prototype.addEventListener = function(type, listener, options){
        if (type === 'DOMNodeInserted' || type === 'DOMNodeRemoved') return;
        return orig.call(this, type, listener, options);
      };
    })();

    /* ---------- Quill ---------- */
    const quill = new Quill('#editor', {
      theme: 'snow',
      modules: {
        toolbar: [
          ['bold', 'italic'],
          [{ header: [1, 2, 3, false] }],
          [{ list: 'ordered' }, { list: 'bullet' }],
          ['image']
        ]
      }
    });

    /* =======================================================
       USERS
    ======================================================= */
    let users = [];
    let userSort = { key: 'last_sign_in', asc: false };

    async function fetchUsers(){
      const res = await fetch('/api/users?with_signin_stats=1', { credentials:'include' });
      if (res.status === 401) return location.href = '/index.html';
      users = await res.json();

      // Default sort by last_sign_in desc (most recent first)
      users.sort((a,b)=>{
        const A = a.last_sign_in ? new Date(a.last_sign_in).getTime() : 0;
        const B = b.last_sign_in ? new Date(b.last_sign_in).getTime() : 0;
        return B - A;
      });

      renderUsers();
    }

    function renderUsers(){
      const tbody = document.querySelector('#users-table tbody');
      const emptyMsg = document.getElementById('users-empty');
      const q = (document.getElementById('user-search').value || '').toLowerCase();

      const filtered = users.filter(u => {
        const name = `${u.first_name ?? ''} ${u.last_name ?? ''}`.trim().toLowerCase();
        const email = (u.email || '').toLowerCase();
        return name.includes(q) || email.includes(q);
      });

      // Sort
      const key = userSort.key;
      const asc = userSort.asc;
      if (key === 'name') {
        filtered.sort((a,b)=>{
          const A = (`${a.first_name ?? ''} ${a.last_name ?? ''}`).trim().toLowerCase();
          const B = (`${b.first_name ?? ''} ${b.last_name ?? ''}`).trim().toLowerCase();
          if (A < B) return asc ? -1 : 1;
          if (A > B) return asc ? 1 : -1;
          return 0;
        });
      } else if (key === 'last_sign_in') {
        filtered.sort((a,b)=>{
          const A = a.last_sign_in ? new Date(a.last_sign_in).getTime() : 0;
          const B = b.last_sign_in ? new Date(b.last_sign_in).getTime() : 0;
          return asc ? (A - B) : (B - A);
        });
      } else {
        filtered.sort(sortBy(key, asc));
      }

      // Only show top 10
      const limited = filtered.slice(0, 10);

      tbody.innerHTML = '';

      if (limited.length === 0) {
        emptyMsg.style.display = 'block';
        return;
      } else emptyMsg.style.display = 'none';

      for (const u of limited) {
        const name = (`${u.first_name ?? ''} ${u.last_name ?? ''}`).trim() || '—';
        const alertChip = (u.distinct_ips_24h >= 3)
          ? `<span class="chip" title="3+ distinct IPs in 24h" style="background:#ffe8e8;color:#a00;border:1px solid #f6caca">Multi-IP</span>`
          : '';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${name}</td>
          <td>${u.email}</td>
          <td>${u.role}</td>
          <td>${u.last_sign_in ? nzDateTime(u.last_sign_in) : ''}</td>
          <td>${u.last_sign_ip ?? ''}</td>
          <td>${alertChip}</td>
          <td>
            <button class="btn" style="padding:.3rem .5rem" data-act="logout" data-id="${u.id}"><i class="fa-solid fa-right-from-bracket"></i></button>
            <button class="btn" style="padding:.3rem .5rem" data-act="reset" data-id="${u.id}"><i class="fa-solid fa-key"></i></button>
            <button class="btn" style="padding:.3rem .5rem;background:#b00020" data-act="delete" data-id="${u.id}"><i class="fa-solid fa-trash"></i></button>
          </td>`;
        tbody.appendChild(tr);
      }
    }

    // Table sorting
    document.querySelectorAll('#users-table th.sortable').forEach(th => {
      th.addEventListener('click', () => {
        const key = th.dataset.key;
        userSort.asc = key === userSort.key ? !userSort.asc : true;
        userSort.key = key;
        renderUsers();
      });
    });

    // Create user
    document.getElementById('create-user-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const btn = document.getElementById('cu-btn');
      const msg = document.getElementById('cu-msg');
      const first = document.getElementById('cu-first').value.trim();
      const last  = document.getElementById('cu-last').value.trim();
      const email = document.getElementById('cu-email').value.trim();
      const role  = document.getElementById('cu-role').value;
      let pass    = document.getElementById('cu-pass').value;
      const sendWelcome = document.getElementById('cu-send-welcome').checked;

      if (!first || !last || !email || !role) {
        msg.textContent = 'All fields except password are required.'; return;
      }
      if (!pass) {
        // simple generator
        pass = Math.random().toString(36).slice(-8) + '!' + Math.floor(100+Math.random()*900);
      }

      btn.disabled = true; msg.textContent = 'Creating…';

      try{
        const res = await fetch('/api/users', {
          method:'POST', credentials:'include',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            first_name:first, last_name:last, email, role, password:pass,
            send_welcome: sendWelcome,
            welcome_name: first  // <-- so your email template can say "Hello {first}"
          })
        });
        if (!res.ok) {
          let data = {}; try{ data=await res.json(); }catch{}
          throw new Error(data.error || 'Failed to create user');
        }
        msg.textContent = 'User created.';
        e.target.reset();
        fetchUsers();
      } catch(err){
        msg.textContent = err.message;
      } finally {
        btn.disabled = false;
      }
    });

    // Row actions: force logout / reset password / delete
    document.getElementById('users-table').addEventListener('click', async (e)=>{
      const b = e.target.closest('button[data-act]');
      if (!b) return;
      const id = b.dataset.id;
      const act = b.dataset.act;

      try {
        if (act === 'logout') {
          if (!confirm('Force sign out this user?')) return;
          const r = await fetch(`/api/users/${id}/logout`, { method:'POST', credentials:'include' });
          if (!r.ok) throw new Error('Failed to force sign out.');
          fetchUsers();
        }

        if (act === 'reset') {
          if (!confirm('Reset password and send email?')) return;
          // Preferred endpoint:
          let r = await fetch(`/api/users/${id}/reset_password`, {
            method:'POST', credentials:'include',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ send_email:true })
          });
          // Fallback to PUT if reset route not present
          if (r.status === 404) {
            const newPass = Math.random().toString(36).slice(-8) + '!' + Math.floor(100+Math.random()*900);
            r = await fetch(`/api/users/${id}`, {
              method:'PUT', credentials:'include',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ password:newPass, send_email:true })
            });
          }
          if (!r.ok) throw new Error('Password reset failed.');
          alert('Password reset initiated.');
        }

        if (act === 'delete') {
          if (!confirm('Delete this user? This cannot be undone.')) return;
          const r = await fetch(`/api/users/${id}`, { method:'DELETE', credentials:'include' });
          if (r.status === 204) {
            fetchUsers();
          } else {
            let data={}; try{ data=await r.json(); }catch{}
            throw new Error(data.error || 'Failed to delete user.');
          }
        }
      } catch (err) {
        alert(err.message || 'Action failed.');
      }
    });

    document.getElementById('user-search').addEventListener('input', renderUsers);

    /* =======================================================
       RESOURCES
    ======================================================= */
    let resources = [];
    let resourceSort = { key: 'created_date', asc: false };

    async function fetchResources(){
      const res = await fetch('/api/resourcespull', { credentials:'include' });
      if (res.status === 401) return location.href = '/index.html';
      resources = await res.json();
      renderResources();
    }

    function renderResources(){
      const tbody = document.querySelector('#resources-table tbody');
      const empty = document.getElementById('resources-empty');
      const q = (document.getElementById('search-resources').value || '').toLowerCase();

      const filtered = resources
        .filter(r => (r.title || '').toLowerCase().includes(q))
        .sort(sortBy(resourceSort.key, resourceSort.asc))
        .slice(0, 10);

      tbody.innerHTML = '';
      if (!filtered.length) { empty.style.display='block'; return; }
      empty.style.display='none';

      for (const r of filtered) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><a href="${r.url}" class="link-nochange" target="_blank" rel="noopener">${r.title}</a></td>
          <td>${r.created_date ? new Date(r.created_date).toLocaleDateString('en-NZ',{timeZone:'Pacific/Auckland'}) : ''}</td>
          <td>${r.category}</td>
          <td>
            <button class="btn" style="padding:.3rem .5rem" data-act="pin-resource" data-id="${r.id}" data-pinned="${r.pinned ? '1':'0'}">
              <i class="${r.pinned ? 'fa-solid':'fa-regular'} fa-star"></i>
            </button>
            <button class="btn" style="padding:.3rem .5rem;background:#b00020" data-act="del-resource" data-id="${r.id}">
              <i class="fa fa-trash"></i>
            </button>
          </td>`;
        tbody.appendChild(tr);
      }
    }

    document.querySelectorAll('#resources-table th.sortable').forEach(th =>
      th.addEventListener('click', ()=>{
        const key = th.dataset.key;
        resourceSort.asc = key === resourceSort.key ? !resourceSort.asc : true;
        resourceSort.key = key;
        renderResources();
      })
    );
    document.getElementById('search-resources').addEventListener('input', renderResources);

    // Toggle pin / delete resource
    document.getElementById('resources-table').addEventListener('click', async (e)=>{
      const b = e.target.closest('button[data-act]');
      if (!b) return;
      const id = b.dataset.id;
      const act = b.dataset.act;

      if (act === 'pin-resource') {
        const pinned = b.dataset.pinned === '1';
        await fetch(`/api/resources/${id}`, {
          method:'PUT', credentials:'include',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ pinned: !pinned })
        });
        fetchResources();
      }
      if (act === 'del-resource') {
        if (!confirm('Delete this resource?')) return;
        await fetch(`/api/resources/${id}`, { method:'DELETE', credentials:'include' });
        fetchResources();
      }
    });

    // Upload resource
    document.getElementById('upload-form').addEventListener('submit', async e=>{
      e.preventDefault();
      const file = document.getElementById('resource-file').files[0];
      const url  = document.getElementById('resource-url').value.trim();
      const title= document.getElementById('resource-title').value.trim();
      const pinned = document.getElementById('resource-pinned').checked;
      const type = document.getElementById('resource-type').value;
      const category = document.getElementById('resource-category').value.trim();

      if (!file && !url) return alert('Provide a file or a URL.');
      if (!title || !type) return alert('Title and type are required.');

      const form = new FormData();
      form.append('title', title);
      form.append('pinned', pinned);
      form.append('type', type);
      form.append('category', category);

      if (file) {
        form.append('file', file);
        if (file.type === 'application/pdf') {
          const pdfThumb = await generatePdfThumbnail(file);
          if (pdfThumb) form.append('thumbnail', pdfThumb);
        }
      } else {
        form.append('url', url);
        try {
          const resp = await fetch(`https://api.microlink.io/?url=${encodeURIComponent(url)}&screenshot=true&meta=false`);
          const data = await resp.json();
          const imgUrl = data?.data?.screenshot?.url;
          if (imgUrl) {
            const blob = await fetch(imgUrl).then(r=>r.blob());
            const base64 = await blobToBase64(blob);
            form.append('thumbnail', base64);
          }
        } catch {}
      }

      await fetch('/api/resources/upload', { method:'POST', body:form, credentials:'include' });
      document.getElementById('upload-form').reset();
      fetchResources();
    });

    async function generatePdfThumbnail(file){
      try{
        const buf = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({ scale: 1 });
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = viewport.width; canvas.height = viewport.height;
        await page.render({ canvasContext: ctx, viewport }).promise;
        return canvas.toDataURL('image/png');
      }catch{ return null; }
    }
    function blobToBase64(blob){
      return new Promise((resolve,reject)=>{
        const r=new FileReader();
        r.onloadend=()=>resolve(r.result);
        r.onerror=reject;
        r.readAsDataURL(blob);
      });
    }

    /* =======================================================
       FEED
    ======================================================= */
    let posts = [];
    let postSort = { key: 'created_at', asc: false };

    async function fetchPosts(){
      const res = await fetch('/api/posts?admin=true', { credentials:'include' });
      if (res.status === 401) return location.href = '/index.html';
      posts = await res.json();
      renderPosts();
    }

    function renderPosts(){
      const tbody = document.querySelector('#posts-table tbody');
      const empty = document.getElementById('posts-empty');
      const q = (document.getElementById('search-posts').value || '').toLowerCase();

      const filtered = posts
        .filter(p => (p.title || '').toLowerCase().includes(q))
        .sort(sortBy(postSort.key, postSort.asc))
        .slice(0, 10);

      tbody.innerHTML = '';
      if (!filtered.length) { empty.style.display='block'; return; }
      empty.style.display='none';

      for (const p of filtered) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.title}</td>
          <td>${p.created_at ? new Date(p.created_at).toLocaleDateString('en-NZ',{timeZone:'Pacific/Auckland'}) : ''}</td>
          <td>${p.category}</td>
          <td>
            <button class="btn" style="padding:.3rem .5rem" data-act="pin-post" data-id="${p.id}" data-cat="${p.category}" data-pinned="${p.pinned ? '1':'0'}">
              <i class="${p.pinned ? 'fa-solid':'fa-regular'} fa-star"></i>
            </button>
            <button class="btn" style="padding:.3rem .5rem;background:#b00020" data-act="del-post" data-id="${p.id}">
              <i class="fa fa-trash"></i>
            </button>
          </td>`;
        tbody.appendChild(tr);
      }
    }

    document.querySelectorAll('#posts-table th.sortable').forEach(th =>
      th.addEventListener('click', ()=>{
        const key = th.dataset.key;
        postSort.asc = key === postSort.key ? !postSort.asc : true;
        postSort.key = key;
        renderPosts();
      })
    );
    document.getElementById('search-posts').addEventListener('input', renderPosts);

    // Toggle pin / delete post
    document.getElementById('posts-table').addEventListener('click', async (e)=>{
      const b = e.target.closest('button[data-act]');
      if (!b) return;
      const id = b.dataset.id;
      const act = b.dataset.act;

      if (act === 'pin-post') {
        const pinned = b.dataset.pinned === '1';
        const category = b.dataset.cat || '';
        const newCat = pinned ? category.replace(/^pinned\s*/i, '') : `pinned ${category}`;
        await fetch(`/api/posts/${id}`, {
          method:'PUT', credentials:'include',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ category: newCat, pinned: !pinned })
        });
        fetchPosts();
      }
      if (act === 'del-post') {
        if (!confirm('Delete this post?')) return;
        await fetch(`/api/posts/${id}`, { method:'DELETE', credentials:'include' });
        fetchPosts();
      }
    });

    // Create post
    document.getElementById('new-post').addEventListener('submit', async e=>{
      e.preventDefault();
      const form = e.target;
      const title = form.title.value.trim();
      const category = form.category.value;
      const pinned = form.pinned.checked;
      const body = quill.root.innerHTML;

      if (!title || !category) return;

      await fetch('/api/posts', {
        method:'POST', credentials:'include',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ title, category: pinned ? `pinned ${category}` : category, body, pinned })
      });
      form.reset(); quill.setContents([]);
      fetchPosts();
    });

    /* =======================================================
       BOOT
    ======================================================= */
    $('.menu-icon').on('click', () => $('.nav-links').toggleClass('active'));
    $(document).ready(function(){
      fetchUsers();
      fetchResources();
      fetchPosts();

      // File-type auto-set
      document.getElementById('resource-file').addEventListener('change', (e)=>{
        const file = e.target.files[0];
        if (file) document.getElementById('resource-type').value='file';
      });
    });
  </script>
</body>
</html>
