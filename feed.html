<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<<<<<<< HEAD
  <title>CESW Hub - Feed</title>

  <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="assets/app.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>body{display:none}</style>
  <script>
    async function signOut(){
      try { await fetch('/api/auth/logout', { method:'POST', credentials:'include' }); }
      finally { location.href = '/index.html'; }
    }
    let ME=null;

    (async () => {
      try {
        const r = await fetch('/api/auth/me', { credentials:'include' });
        if(!r.ok) throw 0;
        ME = await r.json();
        if(!['user','admin'].includes(ME.role)) throw 0;

        // show page
        document.body.style.display = 'block';

        // wire right-side buttons
        const right = document.querySelector('.nav-right');
        if (ME.role === 'admin' && !right.querySelector('a[href="secure.html"]')) {
          const a = document.createElement('a');
          a.className = 'nav-item'; a.href='secure.html'; a.textContent='Admin';
          right.appendChild(a);
        }
        if (!document.getElementById('signOutBtn')) {
          const b = document.createElement('button');
          b.id='signOutBtn'; b.className='nav-item'; b.textContent='Sign out'; b.onclick=signOut;
          right.appendChild(b);
        }
      } catch {
        location.href='/index.html';
      }
    })();
  </script>
</head>
<body>
  <!-- NAV -->
  <div class="navbar">
    <div class="nav-left"><span class="menu-icon">&#9776;</span></div>
    <div class="nav-center">
      <div class="nav-links">
        <a class="nav-item" href="feed.html">Feed</a>
        <a class="nav-item" href="resources.html">Resources</a>
        <a class="nav-item" href="https://calendar.online/87060cd6717c9a3d9e8e" target="_blank" rel="noopener">Calendar</a>
      </div>
    </div>
    <div class="nav-right"></div>
  </div>

  <div class="banner"></div>
  <h2 class="title"><i class="fa-solid fa-list-ul"></i> Feed</h2>

  <main>
    <div id="search-container" class="search-bar-wrap">
      <input type="text" id="searchBar" placeholder="Find a post" class="search-bar">
=======
   <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
  <title>CESW Hub - Feed</title>
  <style>
  body { display: none; }
</style>
<script>
(async () => {
  try {
    const res = await fetch('/api/auth/me', {
      credentials: 'include'
    });
    if (!res.ok) throw new Error('Not authorized');
    const data = await res.json();
    if (!['user', 'admin'].includes(data.role)) {
      window.location.href = '/index.html';
    }
document.body.style.display = 'block';
  } catch (err) {
    window.location.href = '/index.html';
  }
})();
</script>


  <link rel="stylesheet" href="assets/app.css">
</head>
<body>
<div class="navbar">
	<span class="menu-icon">&#9776;</span>
<div class="nav-links">
		<div class="nav-links">
      <a class="nav-item" href="resources.html">Resources</a>
      <a class="nav-item" href="feed.html">Feed</a>
      <a class="nav-item" href="https://calendar.online/87060cd6717c9a3d9e8e">Calendar</a>
		</div>
		</div>
    </div>
    <div class="banner"></div>
    <h2 class="title"><i class="fa-solid fa-list-ul"></i> Feed</h2>  
    
<main>	
    <div id="search-container">
      <input type="text" id="searchBar" placeholder="Find a post">
>>>>>>> 632d8a4809b1944d8bd55f5c2b2b53d77d37c2d4
      <select id="category-select">
        <option value="">All</option>
        <option value="pinned">Pinned</option>
        <option value="general">General</option>
        <option value="faq">FAQ</option>
        <option value="onlineresources">Online Resources</option>
        <option value="resources">Resources</option>
      </select>
    </div>

    <div id="noResults" class="muted" style="display:none">
      Mmm no post found <i class="fa-solid fa-face-sad-tear"></i> Please change your search or try a different category
    </div>
<<<<<<< HEAD

    <div class="card-container" id="cards"></div>
=======
    <div class="card-container"></div>
>>>>>>> 632d8a4809b1944d8bd55f5c2b2b53d77d37c2d4

    <a href="mailto:ITSupport@kotakureo.school.nz" id="contact" class="link-nochange">
      <i class="fa fa-envelope"></i> Contact
    </a>
    <button id="backToTop">
      <i class="fa-solid fa-angle-up"></i> Back to Top
    </button>
  </main>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
<<<<<<< HEAD
    /* ---------- Helpers ---------- */
    function nzDateTime(value){
      const d = new Date(value);
      if (isNaN(d)) return '';
      return d.toLocaleString('en-NZ', {
        timeZone:'Pacific/Auckland',
        year:'numeric', month:'short', day:'2-digit',
        hour:'2-digit', minute:'2-digit'
      }).replace(',', '');
    }
    function escapeHTML(s){
      return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    /* ---------- Account-based favourites (posts) ---------- */
    let favIds = new Set();
    async function loadFavs(){
      const r = await fetch('/api/favourites?type=post', { credentials:'include' });
      const ids = r.ok ? await r.json() : [];
      favIds = new Set(ids.map(String));
    }
    async function setFav(id, on){
      await fetch('/api/favourites', {
        method:'POST', credentials:'include',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ entity_type:'post', entity_id:Number(id), on })
      });
      if (on) favIds.add(String(id)); else favIds.delete(String(id));
    }

    /* ---------- Posts ---------- */
    let posts = [];
    async function loadPosts(){
      const res = await fetch('/api/posts', { credentials:'include' });
      posts = await res.json();
      await loadFavs();
      renderPosts();
      filterCards();
    }

    function renderPosts(){
      const container = document.getElementById('cards');
      container.innerHTML = '';

      posts.forEach(p => {
        const id = String(p.id);
        const isFav = favIds.has(id);
        const cat = (p.category || '').toLowerCase();

        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.id = id;
        card.dataset.name = (p.title || '').toLowerCase();
        card.dataset.category = cat;

        // favourite button
        const fav = document.createElement('button');
        fav.className = 'fav-btn' + (isFav ? ' active' : '');
        fav.title = isFav ? 'Remove from favourites' : 'Add to favourites';
        fav.setAttribute('aria-pressed', String(isFav));
        fav.innerHTML = `<i class="${isFav ? 'fa-solid' : 'fa-regular'} fa-star"></i>`;
        fav.addEventListener('click', async (e) => {
          e.preventDefault();
          const nowOn = !fav.classList.contains('active');
          await setFav(id, nowOn);
          fav.classList.toggle('active', nowOn);
          fav.setAttribute('aria-pressed', String(nowOn));
          fav.title = nowOn ? 'Remove from favourites' : 'Add to favourites';
          fav.querySelector('i').className = nowOn ? 'fa-solid fa-star' : 'fa-regular fa-star';
          filterCards(); // updates if "My Favourites" filter is active
        });
        card.appendChild(fav);

        // title
        const h1 = document.createElement('h1');
        h1.textContent = p.title || '';
        card.appendChild(h1);

        // body (server should sanitize)
        const body = document.createElement('div');
        body.innerHTML = p.body || '';
        card.appendChild(body);

        // meta
        const meta = document.createElement('div');
        meta.innerHTML = `<br><i>${escapeHTML(new Date(p.created_at).toLocaleDateString())} ${escapeHTML(p.category || '')}</i>`;
        card.appendChild(meta);

        // comments block
        card.appendChild(buildCommentsBlock(p.id));

        container.appendChild(card);

        // update comment count initially
        loadComments(p.id, { countOnly:true });
=======
    async function loadPosts() {
      const res = await fetch('/api/posts');
      const posts = await res.json();

      // Server already ordered by pinned & date
      const container = document.querySelector('.card-container');
      container.innerHTML = '';

      posts.forEach(p => {
        const displayCat = p.category.toLowerCase();
        const div = document.createElement('div');
        div.className         = 'card';
        div.dataset.name      = p.title.toLowerCase();
        div.dataset.category  = displayCat;
        div.innerHTML = `
          <h1>${p.title}</h1>
          <div>${p.body}</div>
          <br><i>${new Date(p.created_at).toLocaleDateString()} ${p.category}</i>
        `;
        container.append(div);
>>>>>>> 632d8a4809b1944d8bd55f5c2b2b53d77d37c2d4
      });

      filterCards();
    }

<<<<<<< HEAD
    /* ---------- Comments ---------- */
    const commentCache = new Map(); // postId -> array
    function buildCommentsBlock(postId){
      const wrap = document.createElement('div');
      wrap.className = 'comments';
      wrap.dataset.post = String(postId);

      const header = document.createElement('div');
      header.className = 'c-header';

      const count = document.createElement('span');
      count.className = 'c-count';
      count.id = `cc-${postId}`;
      count.textContent = 'Comments';
      header.appendChild(count);

      const toggle = document.createElement('button');
      toggle.className = 'c-toggle';
      toggle.dataset.post = String(postId);
      toggle.innerHTML = `<i class="fa-regular fa-comments"></i> View`;
      toggle.addEventListener('click', () => {
        const list = document.getElementById(`cl-${postId}`);
        const editor = document.getElementById(`ce-${postId}`);
        const open = list.style.display !== 'none';
        if (open) {
          list.style.display = 'none';
          editor.style.display = 'none';
        } else {
          loadComments(postId, { countOnly:false });
          list.style.display = 'block';
          editor.style.display = 'flex';
        }
      });
      header.appendChild(toggle);

      wrap.appendChild(header);

      const list = document.createElement('div');
      list.className = 'c-list';
      list.id = `cl-${postId}`;
      list.style.display = 'none';
      wrap.appendChild(list);

      const editor = document.createElement('div');
      editor.className = 'c-editor';
      editor.id = `ce-${postId}`;
      editor.style.display = 'none';

      const ta = document.createElement('textarea');
      ta.placeholder = 'Write a comment…';
      editor.appendChild(ta);

      const send = document.createElement('button');
      send.className = 'c-send';
      send.dataset.post = String(postId);
      send.innerHTML = `<i class="fa-solid fa-paper-plane"></i> Post`;
      send.addEventListener('click', async () => {
        const text = ta.value.trim();
        if (!text) return;
        await fetch('/api/comments', {
          method:'POST', credentials:'include',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ post_id:postId, body:text })
        });
        ta.value = '';
        loadComments(postId, { countOnly:false });
      });
      editor.appendChild(send);
      wrap.appendChild(editor);

      return wrap;
    }

    function byParentTree(list){
      const map = new Map();
      list.forEach(c => map.set(c.id, { ...c, replies:[] }));
      const roots = [];
      map.forEach(c => {
        if (c.parent_id) {
          const p = map.get(c.parent_id);
          if (p) p.replies.push(c);
          else roots.push(c);
        } else {
          roots.push(c);
        }
      });
      return roots;
    }

    async function loadComments(postId, { countOnly=false } = {}){
      const r = await fetch(`/api/comments?post_id=${postId}`, { credentials:'include' });
      const arr = r.ok ? await r.json() : [];
      commentCache.set(postId, arr);
      const count = arr.filter(c => !c.deleted_at).length;
      const cc = document.getElementById(`cc-${postId}`);
      if (cc) cc.textContent = `Comments (${count})`;
      if (countOnly) return;
      renderComments(postId);
    }

    function canEditComment(c){
      if (!ME) return false;
      return (ME.role === 'admin') || (ME.email === c.author_email);
    }

    function renderCommentHTML(c){
      const del = !!c.deleted_at;
      const name = (c.author_name || '').trim() || c.author_email;
      const meta = `<div class="meta"><strong>${escapeHTML(name)}</strong><span>${nzDateTime(c.created_at)}</span></div>`;
      const body = del
        ? `<div class="muted"><i>deleted</i></div>`
        : `<div class="c-body">${escapeHTML(c.body)}</div>`;
      const actions = del ? '' : `
        <div class="c-actions">
          <button class="c-reply" data-id="${c.id}" data-post="${c.post_id}">Reply</button>
          ${canEditComment(c) ? `
            <button class="c-edit" data-id="${c.id}" data-post="${c.post_id}">Edit</button>
            <button class="c-del"  data-id="${c.id}" data-post="${c.post_id}">Delete</button>
          ` : ''}
        </div>`;
      const replies = (c.replies || []).map(r => `<div class="reply">${renderCommentHTML(r)}</div>`).join('');
      return `<div class="comment" data-cid="${c.id}">${meta}${body}${actions}${replies}</div>`;
    }

    function renderComments(postId){
      const list = commentCache.get(postId) || [];
      const tree = byParentTree(list);
      const wrap = document.getElementById(`cl-${postId}`);
      if (!wrap) return;
      wrap.innerHTML = tree.map(c => renderCommentHTML(c)).join('');
    }

    // delegated actions for replies / edit / delete
    document.addEventListener('click', async (e) => {
      const replyBtn = e.target.closest('.c-reply');
      const saveBtn  = e.target.closest('.c-save');
      const editBtn  = e.target.closest('.c-edit');
      const delBtn   = e.target.closest('.c-del');
      const sendReplyBtn = e.target.closest('.c-send-reply');

      if (replyBtn) {
        const postId = Number(replyBtn.dataset.post);
        const cid = Number(replyBtn.dataset.id);
        const parent = replyBtn.closest('.comment');
        if (parent.querySelector('.c-editor')) return;
        const box = document.createElement('div');
        box.className = 'c-editor';
        box.innerHTML = `<textarea placeholder="Write a reply…"></textarea>
                         <button class="c-send-reply" data-post="${postId}" data-parent="${cid}">Reply</button>`;
        parent.appendChild(box);
      }

      if (sendReplyBtn) {
        const postId = Number(sendReplyBtn.dataset.post);
        const pid = Number(sendReplyBtn.dataset.parent);
        const ta = sendReplyBtn.previousElementSibling;
        const text = ta.value.trim();
        if (!text) return;
        await fetch('/api/comments', {
          method:'POST', credentials:'include',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ post_id:postId, parent_id:pid, body:text })
        });
        loadComments(postId, { countOnly:false });
      }

      if (editBtn) {
        const postId = Number(editBtn.dataset.post);
        const cid = Number(editBtn.dataset.id);
        const wrap = editBtn.closest('.comment');
        const body = wrap.querySelector('.c-body');
        if (!body) return;
        const current = body.textContent;
        body.outerHTML = `<div class="c-editor">
            <textarea>${escapeHTML(current)}</textarea>
            <button class="c-save" data-post="${postId}" data-id="${cid}">Save</button>
          </div>`;
      }

      if (saveBtn) {
        const postId = Number(saveBtn.dataset.post);
        const cid = Number(saveBtn.dataset.id);
        const ta = saveBtn.previousElementSibling;
        const text = ta.value.trim();
        if (!text) return;
        await fetch(`/api/comments/${cid}`, {
          method:'PUT', credentials:'include',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ body:text })
        });
        loadComments(postId, { countOnly:false });
      }

      if (delBtn) {
        const postId = Number(delBtn.dataset.post);
        const cid = Number(delBtn.dataset.id);
        if (!confirm('Delete this comment?')) return;
        await fetch(`/api/comments/${cid}`, {
          method:'DELETE', credentials:'include'
        });
        loadComments(postId, { countOnly:false });
      }
    });

    /* ---------- Filters & page wiring ---------- */
    function filterCards(){
      const val = (document.getElementById('searchBar').value || '').toLowerCase();
      const cat = (document.getElementById('category-select').value || '').toLowerCase();
      let shown = 0;

      document.querySelectorAll('.card').forEach(c => {
        const name = (c.dataset.name || '');
        const catOfCard = (c.dataset.category || '');
        const id = (c.dataset.id || '');
        const matchesSearch = name.includes(val);
        let matchesCategory = true;
        if (cat) {
          if (cat === 'favourites') matchesCategory = favIds.has(id);
          else matchesCategory = catOfCard.includes(cat);
        }
        const ok = matchesSearch && matchesCategory;
        c.style.display = ok ? '' : 'none';
        if (ok) shown++;
      });

      document.getElementById('noResults').style.display = shown === 0 ? '' : 'none';
    }

    // menu, scroll UI
    $('.menu-icon').on('click', () => $('.nav-links').toggleClass('active'));
    $(window).on('scroll', () => {
      const scrolled = $(window).scrollTop() > 100;
      $('#backToTop, #contact').toggle(scrolled);
=======
    function filterCards() {
      let val = $('#searchBar').val().toLowerCase();
      const cat = $('#category-select').val().toLowerCase();
      let shown = 0;



      $('.card').each(function() {
        const name = $(this).data('name');
        const c    = $(this).data('category');
        const ok   = name.includes(val) && (!cat || c.includes(cat));
        $(this).toggle(ok);
        if (ok) shown++;
      });

      $('#noResults').toggle(shown === 0);
    }
        // Toggle menu
    $('.menu-icon').click(function () {
        $('.nav-links').toggleClass('active');
>>>>>>> 632d8a4809b1944d8bd55f5c2b2b53d77d37c2d4
    });
    $('#backToTop').on('click', () => $('html, body').animate({ scrollTop: 0 }, 'fast'));

<<<<<<< HEAD
    $(document).ready(function(){
=======
    $(document).ready(function() {
>>>>>>> 632d8a4809b1944d8bd55f5c2b2b53d77d37c2d4
      loadPosts();
      $('#searchBar')
        .focus()
        .on('keyup input', filterCards)
        .on('input', function() {
          clearTimeout($.data(this,'timer'));
          const self = this;
          $.data(this,'timer', setTimeout(() => $(self).blur(), 10000));
        })
        .on('keydown', function() {
          clearTimeout($.data(this,'timer'));
        });
      $('#category-select').on('change', filterCards);
<<<<<<< HEAD
=======

      $(window).on('scroll', () => {
        const scrolled = $(window).scrollTop() > 100;
        $('#backToTop, #contact').toggle(scrolled);
      });
      $('#backToTop').on('click', () =>
        $('html, body').animate({ scrollTop: 0 }, 'fast')
      );
>>>>>>> 632d8a4809b1944d8bd55f5c2b2b53d77d37c2d4
    });
  </script>
</body>
</html>
