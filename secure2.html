<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - CESW Hub</title>
  <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="assets/admin.css">
  <style>
  
  </style>
</head>
<body>
  <div class="banner"></div>
  <main style="max-width: 800px; margin: auto;">
    <h1 class="title"><i class="fa-solid fa-book-open-reader"></i> CESW Hub: Admin Dashboard</h1>

    <!-- ====================== ADD POST ======================= -->
    <h2 class="title">Add Post</h2>
    <form id="new-post">
      <input name="title" id="new-post-input" type="text" placeholder="Title" required />
      <select name="category" id="new-post-select" required>
        <option value="" disabled selected>Select category</option>
        <option value="general">General</option>  
      </select>
      <label class="star-checkbox">
        <input type="checkbox" name="pinned" />
        <i class="fa-regular fa-star unchecked"></i>
        <i class="fa-solid fa-star checked"></i>
        Pin this post
      </label>
      <div id="editor"></div>
      <button type="submit" id="new-post-button">Create Post</button>
    </form>

    <h2 class="title">Manage Posts</h2>
    <table id="posts-list">
      <thead><tr><th>Title</th><th>Category</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>

    <!-- ====================== UPLOAD RESOURCE ======================= -->
    <h2 class="title">Upload Resource</h2>
    <form id="upload-form" class="upload-section" enctype="multipart/form-data">
      <input type="text" id="resource-title" placeholder="Resource title" required />
      <input type="file" id="resource-file" required />
      <label class="star-checkbox">
        <input type="checkbox" id="resource-pinned" />
        <i class="fa-regular fa-star unchecked"></i>
        <i class="fa-solid fa-star checked"></i>
        Pin this resource
      </label>
      <button type="submit" id="new-upload-button">Upload File</button>
    </form>

    <h2 class="title">Manage Resources</h2>
    <table id="resources-list">
      <thead><tr><th>Title</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </main>

  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script>
    const quill = new Quill('#editor', {
      theme: 'snow',
      modules: {
        toolbar: [
          ['bold', 'italic'],
          [{ header: [1, 2, 3, false] }],
          [{ list: 'ordered' }, { list: 'bullet' }],
          ['image']
        ]
      }
    });

    async function loadAdminPosts() {
      const res = await fetch('/api/posts?admin=true', { credentials: 'include' });
      if (res.status === 401) return window.location.href = '/login.html';
      const posts = await res.json();

      const tbody = document.querySelector('#posts-list tbody');
      tbody.innerHTML = '';

      posts.forEach(p => {
        const isPinned = p.pinned === 1;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${p.title}</td>
          <td>${p.category}</td>
          <td>
            <button class="pin-btn ${isPinned ? 'unpin' : ''}" data-id="${p.id}">
              <i class="${isPinned ? 'fa-solid fa-star' : 'fa-regular fa-star'}"></i>
              ${isPinned ? 'Unpin' : 'Pin'}
            </button>
            <button class="delete-btn" data-id="${p.id}">
              <i class="fa fa-trash"></i> Delete
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });

      document.querySelectorAll('.pin-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const currentlyPinned = btn.classList.contains('unpin');
          const row = btn.closest('tr');
          const rawCat = row.querySelector('td:nth-child(2)').textContent;
          const baseCat = rawCat.replace(/^pinned\s*/i, '');
          const newCat = currentlyPinned ? baseCat : `pinned ${baseCat}`;

          await fetch(`/api/posts/${id}`, {
            method: 'PUT',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ category: newCat, pinned: !currentlyPinned })
          });
          loadAdminPosts();
        });
      });

      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!window.confirm('Are you sure you want to delete this post?')) return;
          await fetch(`/api/posts/${btn.dataset.id}`, {
            method: 'DELETE',
            credentials: 'include'
          });
          loadAdminPosts();
        });
      });
    }

    document.getElementById('new-post').addEventListener('submit', async e => {
      e.preventDefault();
      const form = e.target;
      const title = form.title.value;
      let category = form.category.value;
      const pinned = form.pinned.checked;

      if (pinned) category = `pinned ${category}`;

      await fetch('/api/posts', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, category, body: quill.root.innerHTML, pinned })
      });

      form.reset();
      quill.setContents([]);
      loadAdminPosts();
    });

    // ========== RESOURCES ==========

    document.getElementById('upload-form').addEventListener('submit', async e => {
      e.preventDefault();
      const file = document.getElementById('resource-file').files[0];
      const title = document.getElementById('resource-title').value;
      const pinned = document.getElementById('resource-pinned').checked;
      if (!file) return alert("Please select a file");

      const formData = new FormData();
      formData.append('file', file);
      formData.append('title', title);
      formData.append('pinned', pinned);

      const res = await fetch('/api/resources/upload', {
        method: 'POST',
        body: formData,
        credentials: 'include'
      });

      if (res.ok) {
        document.getElementById('upload-form').reset();
        loadResources();
      } else {
        alert('Upload failed');
      }
    });

    async function loadResources() {
      const res = await fetch('/api/resourcespull', { credentials: 'include' });
      if (res.status === 401) return window.location.href = '/login.html';

      const data = await res.json();
      const tbody = document.querySelector('#resources-list tbody');
      tbody.innerHTML = '';

      data.forEach(r => {
        const isPinned = r.pinned === 1;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><a href="${r.url}" target="_blank">${r.title}</a></td>
          <td>
            <button class="pinresource-btn ${isPinned ? 'unpin' : ''}" data-id="${r.id}">
              <i class="${isPinned ? 'fa-solid fa-star' : 'fa-regular fa-star'}"></i>
              ${isPinned ? 'Unpin' : 'Pin'}
            </button>
            <button class="deleteresource-btn" data-id="${r.id}">
              <i class="fa fa-trash"></i> Delete
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });

      document.querySelectorAll('.pinresource-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const currentlyPinned = btn.classList.contains('unpin');
          await fetch(`/api/resources/${id}`, {
            method: 'PUT',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pinned: !currentlyPinned })
          });
          loadResources();
        });
      });

      document.querySelectorAll('.deleteresource-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!window.confirm('Are you sure you want to delete this resource?')) return;
          await fetch(`/api/resources/${btn.dataset.id}`, {
            method: 'DELETE',
            credentials: 'include'
          });
          loadResources();
        });
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadAdminPosts();
      loadResources();
    });
  </script>
</body>
</html>